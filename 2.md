# Лабораторная работа №2. Простейший чат-бот в Telegram

<ins>Цель</ins>: получение навыков работы с библиотекой Aiogram, связка API OpenAI и написанного бота.

## План

1. Настройка окружения;
2. Написание основных функций бота;
3. Задания.

---
## 1. Базовая реализация бота

На первом этапе была воспроизведена базовая структура бота по предоставленному примеру. В результате реализован бот, который:
реагирует на команду /start,поддерживает кнопку запуска,принимает текстовые сообщения и возвращает ответы.

Пример результата работы:

<img width="1183" height="1000" alt="image" src="https://github.com/user-attachments/assets/795c66b4-c8f6-40a6-8655-9ae2439713fe" />

## 2. Реализация заданий
2.1 Добавление системного промпта

Системный промпт был добавлен в файл .env для удобства конфигурации и возможности изменения без редактирования исходного кода.

<img width="576" height="23" alt="image" src="https://github.com/user-attachments/assets/e3f5aeaf-160e-4259-b593-0f546f0c4af1" />
 
2.2 Обращение к пользователю по имени

Для персонализации взаимодействия бот получает данные пользователя и использует full_name в приветственном сообщении при выполнении команды /start.
```python
@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    try:
        user = await get_user(message)

        text = (
            f"Привет, <b>{user.full_name}</b>! Я бот-ассистент.\n"
            f"Пишите вопросы — постараюсь помочь.\n\n"
            f"Команды:\n"
            f"/reset-context — сбросить контекст"
        )

        await message.answer(text)

    except Exception as e:
        logging.exception("Start handler error")
        await message.answer("Ошибка в /start")
```
## 2.3 Хранение сообщений и поддержка контекста (SQLite + SQLAlchemy)

Для хранения истории диалога была использована база данных SQLite.
В качестве ограничения истории установлен лимит последних сообщений:
```python
CONTEXT_LIMIT = int(os.getenv("CONTEXT_LIMIT", "12"))
```
Модели базы данных
```python
from sqlalchemy import String, Integer, DateTime, ForeignKey, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship
from datetime import datetime
from .base import Base
```
```python
class User(Base):
    __tablename__ = "users"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    tg_id: Mapped[int] = mapped_column(Integer, unique=True, index=True)
    full_name: Mapped[str] = mapped_column(String(255))

    messages: Mapped[list["Message"]] = relationship(back_populates="user")


class Message(Base):
    __tablename__ = "messages"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)

    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"), index=True)
    role: Mapped[str] = mapped_column(String(32))  # "user" | "assistant" | "system"
    content: Mapped[str] = mapped_column(Text)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    user: Mapped["User"] = relationship(back_populates="messages")
```
Операции с пользователями и сообщениями

Реализованы функции:создание/получение пользователя,добавление сообщения,получение последних сообщений для контекста,удаление истории (сброс контекста).
```python
from sqlalchemy import select, delete
from sqlalchemy.ext.asyncio import AsyncSession

from .models import User, Message


async def get_or_create_user(
    session: AsyncSession,
    tg_id: int,
    full_name: str,
) -> User:
    query = select(User).where(User.tg_id == tg_id)
    result = await session.execute(query)
    user: User | None = result.scalar_one_or_none()

    if not user:
        user = User(
            tg_id=tg_id,
            full_name=full_name,
        )
        session.add(user)
        await session.commit()
        await session.refresh(user)
        return user

    if user.full_name != full_name:
        user.full_name = full_name
        await session.commit()

    return user


async def add_message(
    session: AsyncSession,
    user_id: int,
    role: str,
    content: str,
) -> None:
    message = Message(
        user_id=user_id,
        role=role,
        content=content,
    )
    session.add(message)
    await session.commit()


async def get_last_messages(
    session: AsyncSession,
    user_id: int,
    limit: int,
) -> list[Message]:
    query = (
        select(Message)
        .where(Message.user_id == user_id)
        .order_by(Message.created_at.desc())
        .limit(limit)
    )

    result = await session.execute(query)
    messages = result.scalars().all()

    return messages[::-1]


async def reset_context(
    session: AsyncSession,
    user_id: int,
) -> None:
    query = delete(Message).where(Message.user_id == user_id)
    await session.execute(query)
    await session.commit()
```
## 2.4 Команда /reset-context

Добавлена команда, которая удаляет сохранённые сообщения пользователя и тем самым сбрасывает контекст диалога.
```python
@dp.message(Command("reset-context"))
async def reset_context_handler(message: Message) -> None:
    try:
        async with AsyncSessionLocal() as session:
            user = await get_or_create_user(
                session=session,
                tg_id=message.from_user.id,
                full_name=message.from_user.full_name or "Пользователь"
            )
            await reset_context(session, user.id)

        await message.answer("Контекст диалога сброшен.")

    except Exception:
        logging.exception("Reset context error")
        await message.answer("Ошибка при сбросе контекста.")
```
## 2.5 Обработка изображений

Добавлена обработка входящих изображений без отправки в нейросеть. При получении фотографии бот отвечает сообщением, что изображение получено.

Пример:
```python
<img width="487" height="647" alt="image" src="https://github.com/user-attachments/assets/e4f68c87-f5d4-40de-95c4-a797fbd69730" />
@dp.message(lambda m: m.photo is not None)
async def photo_handler(message: Message) -> None:
    try:
        user = await get_user_from_message(message, "Пользователь")
        await save_message(user.id, "user", "[PHOTO]")

        await message.answer("Вы отправили изображение.")

    except Exception as e:
        logging.error(f"Photo handler error: {e}")
        await message.answer("Ошибка при обработке изображения.")
```
## 3. Выполненные задания

Добавлен системный промпт — выполнено

Реализовано обращение к пользователю по имени — выполнено

Добавлено хранение сообщений (SQLite) — выполнено

Реализована поддержка контекста диалога на основе БД — выполнено

Добавлена команда /reset-context — выполнено

Добавлена обработка изображений (ответ текстом) — выполнено





