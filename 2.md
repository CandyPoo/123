# Лабораторная работа №2. Простейший чат-бот в Telegram

<ins>Цель</ins>: получение навыков работы с библиотекой Aiogram, связка API OpenAI и написанного бота.

## План

1. Настройка окружения;
2. Написание основных функций бота;
3. Задания.

---

## 1. Мы сделали всю базу которая была в примере и получилось вот это 

<img width="1183" height="1000" alt="image" src="https://github.com/user-attachments/assets/795c66b4-c8f6-40a6-8655-9ae2439713fe" />

Мы создали простого бота который имеет кнопку старта и может отвечать на вопросы.

## 2. Задания делаем

Далее по заданиям нужно было реализовать:
-Добавить системный промт, я просто его написала в `.env`.
<img width="576" height="23" alt="image" src="https://github.com/user-attachments/assets/e3f5aeaf-160e-4259-b593-0f546f0c4af1" />

-Следующее задание было реализовать обращение по имени к пользователю
сделала я это тут вот так 
```python
@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    try:
        user = await get_user(message)

        text = (
            f"Привет, <b>{user.full_name}</b>! Я бот-ассистент Крысиный король Ратистор.\n"
            f"Пиши вопросы — может я отвечу.\n\n"
            f"Команды:\n"
            f"/reset-context — сбросить контекст"
        )

        await message.answer(text)

    except Exception as e:
        logging.exception("Start handler error")
        await message.answer("Ошибка в /start")
```
-После я реализовала хранение данных с помощью SQLlite

Я взяла за норму 12 сообщений для хранения 
```python
CONTEXT_LIMIT = int(os.getenv("CONTEXT_LIMIT", "12"))
```

А вот тут мы храним сообщения для нейронки 

```python
from sqlalchemy import String, Integer, DateTime, ForeignKey, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship
from datetime import datetime
from .base import Base

class User(Base):
    __tablename__ = "users"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    tg_id: Mapped[int] = mapped_column(Integer, unique=True, index=True)
    full_name: Mapped[str] = mapped_column(String(255))

    messages: Mapped[list["Message"]] = relationship(back_populates="user")


class Message(Base):
    __tablename__ = "messages"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)

    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"), index=True)
    role: Mapped[str] = mapped_column(String(32))  # "user" | "assistant" | "system"
    content: Mapped[str] = mapped_column(Text)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    user: Mapped["User"] = relationship(back_populates="messages")


```
Вот тут мы храним сообщения пользователя, имя пользователя, сбрасывать лишнее сообщения 
```python
from sqlalchemy import select, delete
from sqlalchemy.ext.asyncio import AsyncSession

from .models import User, Message


async def get_or_create_user(
    session: AsyncSession,
    tg_id: int,
    full_name: str,
) -> User:
    query = select(User).where(User.tg_id == tg_id)
    result = await session.execute(query)
    user: User | None = result.scalar_one_or_none()

    if not user:
        user = User(
            tg_id=tg_id,
            full_name=full_name,
        )
        session.add(user)
        await session.commit()
        await session.refresh(user)
        return user

    if user.full_name != full_name:
        user.full_name = full_name
        await session.commit()

    return user


async def add_message(
    session: AsyncSession,
    user_id: int,
    role: str,
    content: str,
) -> None:
    message = Message(
        user_id=user_id,
        role=role,
        content=content,
    )
    session.add(message)
    await session.commit()


async def get_last_messages(
    session: AsyncSession,
    user_id: int,
    limit: int,
) -> list[Message]:
    query = (
        select(Message)
        .where(Message.user_id == user_id)
        .order_by(Message.created_at.desc())
        .limit(limit)
    )

    result = await session.execute(query)
    messages = result.scalars().all()

    return messages[::-1]


async def reset_context(
    session: AsyncSession,
    user_id: int,
) -> None:
    query = delete(Message).where(Message.user_id == user_id)
    await session.execute(query)
    await session.commit()

```
-Так же одим из заданий было реализовать кнопку `/reset-context` я сделала это вот тут вот так 
```python
@dp.message(Command("reset-context"))
async def reset_context_handler(message: Message) -> None:
    try:
        async with AsyncSessionLocal() as session:
            user = await get_or_create_user(
                session=session,
                tg_id=message.from_user.id,
                full_name=message.from_user.full_name or "слуга"
            )
            await reset_context(session, user.id)

        await message.answer("Так уж и быть сброшу")

    except Exception:
        logging.exception("Reset context error")
        await message.answer("Ну ты лох ничего не сброшу тебе((")

```
-Последним заданием было реализовать отправку сообщения "Вы отправили картинку!" при отправке картинки
<img width="487" height="647" alt="image" src="https://github.com/user-attachments/assets/e4f68c87-f5d4-40de-95c4-a797fbd69730" />
```python
@dp.message(lambda m: m.photo is not None)
async def photo_handler(message: Message) -> None:
    try:
        user = await get_user_from_message(message, "Друг")
        await save_message(user.id, "user", "[PHOTO]")

        await message.answer("Вы отправили картинку,крыса!")

    except Exception as e:
        logging.error(f"Photo handler error: {e}")
        await message.answer("Ошибка при обработке картинки, крыса")

```
## 3. Задания

1. Добавьте к ассистенту системный промпт;(готово)
2. Сделайте так, чтобы бот знал имя пользователя и при ответе обращался к нему по имени;(готово)
3. Добавьте хранение сообщений (добавьте базу данных);
4. Добавьте поддержку контекста диалога (используйте базу данных из задания 3);
4. Добавьте команду `/reset-context`, которая будет сбрасывать контекст диалога;(готово)
5. Добавьте поддержку отправки изображений (без их обработки нейронкой, в реплае просто текстом отвечайте, что "Вы отправили картинку!").(готово)

---






